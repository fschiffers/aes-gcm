<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AES-GCM 256</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.5/dist/umd/popper.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js" crossorigin="anonymous"></script>
</head>
<body>
  <div class="container">
    <h1 class="my-4">AES-GCM 256</h1>
    <div class="mb-3">
      <label for="key-input" class="form-label">Key:</label>
      <input type="text" class="form-control" id="key-input">
    </div>
    <div class="mb-3">
      <label for="text-input" class="form-label">Text:</label>
      <textarea class="form-control" id="text-input"></textarea>
    </div>
    <div class="mb-3">
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="format" id="hex-format" value="hex" checked>
        <label class="form-check-label" for="hex-format">Hex</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="format" id="base64-format" value="base64">
        <label class="form-check-label" for="base64-format">Base64</label>
      </div>
    </div>
    <div class="mb-3">
      <button class="btn btn-primary" onclick="encrypt()">Encrypt</button>
      <button class="btn btn-secondary" onclick="decrypt()">Decrypt</button>
    </div>
    <div class="mb-3">
      <label for="output" class="form-label">Output:</label>
      <textarea class="form-control" id="output" readonly></textarea>
    </div>
    <div class="mb-3">
        <button class="btn btn-primary" onclick="copyResult()">Copy Result</button>
      </div>      
  </div>

  <script>


    function getSelectedFormat() {
      return document.querySelector('input[name="format"]:checked').value;
    }

    async function deriveKey(keyStr) {
  const baseKey = await window.crypto.subtle.importKey(
    "raw", new TextEncoder().encode(keyStr), "PBKDF2", false, ["deriveKey"]
  );
  const derivedKey = await window.crypto.subtle.deriveKey(
    { name: "PBKDF2", salt: new Uint8Array(16), iterations: 100000, hash: "SHA-256" },
    baseKey, { name: "AES-GCM", length: 256 }, false, ["encrypt", "decrypt"]
  );
  return derivedKey;
}

async function encrypt() {
  const keyStr = document.getElementById("key-input").value;
  const text = document.getElementById("text-input").value;
  const key = await deriveKey(keyStr);
  const iv = window.crypto.getRandomValues(new Uint8Array(12));
  const encrypted = await window.crypto.subtle.encrypt(
    { name: "AES-GCM", iv: iv }, key, new TextEncoder().encode(text)
  );
  const encryptedArray = new Uint8Array(encrypted);
  const resultArray = new Uint8Array(12 + encryptedArray.length);
  resultArray.set(iv);
  resultArray.set(encryptedArray, 12);

  const selectedFormat = getSelectedFormat();
  let result;
  if (selectedFormat === 'hex') {
    result = Array.from(resultArray, b => b.toString(16).padStart(2, '0')).join('');
  } else {
    result = btoa(String.fromCharCode.apply(null, resultArray));
  }

  document.getElementById("output").value = result;
}


async function decrypt() {
  const keyStr = document.getElementById("key-input").value;
  const input = document.getElementById("text-input").value;

  const selectedFormat = getSelectedFormat();

  let encryptedArray;
  if (selectedFormat === 'hex') {
    // Check that the input data is a valid hexadecimal string
    if (!/^[0-9a-fA-F]+$/.test(input)) {
      console.error("Error: Invalid input data format.");
      document.getElementById("output").value = "Error: Invalid input data format.";
      return;
    }
    encryptedArray = new Uint8Array(input.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));
  } else {
    encryptedArray = new Uint8Array(atob(input).split('').map(c => c.charCodeAt(0)));
  }

  // Check that the input data contains the IV and encrypted data
  if (encryptedArray.length < 28) {
    console.error("Error: Invalid input data length.");
    document.getElementById("output").value = "Error: Invalid input data length.";
    return;
  }

  const iv = encryptedArray.slice(0, 12);
  const encrypted = encryptedArray.slice(12);
  const key = await deriveKey(keyStr);

  try {
    const decrypted = await window.crypto.subtle.decrypt(
      { name: "AES-GCM", iv: iv, tagLength: 128 }, key, encrypted
    );
    const decryptedText = new TextDecoder().decode(decrypted);
    document.getElementById("output").value = decryptedText;
  } catch (err) {
    console.error(err);
    document.getElementById("output").value = "Error: Invalid decryption key or tampered data.";
  }
}

function copyResult() {
  const outputField = document.getElementById("output");
  outputField.select();
  document.execCommand("copy");
  const messageField = document.createElement("div");
  messageField.textContent = "Result copied to clipboard!";
  messageField.classList.add("alert", "alert-success", "mt-3");
  const container = document.querySelector(".container");
  container.appendChild(messageField);
  setTimeout(() => container.removeChild(messageField), 3000);
}


    // The rest of the code remains unchanged
  </script>
  <div class="container mt-4">
    <p class="text-center text-muted small">
      This script runs entirely on the client side, and no data is stored on the server. Please note that GitHub Pages tracks visitors' IP addresses for security reasons. More information can be found <a href="https://docs.github.com/en/pages/getting-started-with-github-pages/about-github-pages#data-collection" target="_blank">here</a>. 
      Code available on <a href="https://github.com/kbagher/aes-gcm" target="_blank">GitHub</a>.
    </p>
  </div>
</body>
</html>
